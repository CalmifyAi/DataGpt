<script>
/* =========================
   AUDIO BOOT + AI VOICE
========================= */
function bootSound() {
  const ctx = new AudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(80, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(420, ctx.currentTime + 1.2);
  gain.gain.setValueAtTime(0.15, ctx.currentTime);
  osc.connect(gain).connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 1.2);
}

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.9 + Math.random() * 0.2;
  u.pitch = 0.8 + Math.random() * 0.4;
  speechSynthesis.speak(u);
}

/* =========================
   MATRIX RAIN
========================= */
const matrixCanvas = document.getElementById("matrix");
const mtx = matrixCanvas.getContext("2d");
matrixCanvas.width = innerWidth;
matrixCanvas.height = innerHeight;

const chars = "アカサタナABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
const size = 16;
const columns = matrixCanvas.width / size;
const drops = Array.from({ length: columns }).fill(1);

function matrix() {
  mtx.fillStyle = "rgba(0,0,0,0.08)";
  mtx.fillRect(0,0,matrixCanvas.width,matrixCanvas.height);
  mtx.fillStyle = "#b98cff";
  mtx.font = size + "px monospace";
  drops.forEach((y,i)=>{
    const t = chars[Math.floor(Math.random()*chars.length)];
    mtx.fillText(t, i*size, y*size);
    drops[i] = y*size > matrixCanvas.height && Math.random()>0.975 ? 0 : y+1;
  });
}
setInterval(matrix, 45);

/* =========================
   THINKING BAR
========================= */
function thinkingBar(cb) {
  let p = 0;
  output.innerHTML = `<h3>INITIALIZING AI CORE</h3><div id="bar"></div>`;
  const bar = document.getElementById("bar");
  bar.style.height = "8px";
  bar.style.background = "#7f4bff";
  bar.style.width = "0%";
  bar.style.transition = "width 0.3s";

  const phases = [
    "Parsing input",
    "Detecting patterns",
    "Cross-referencing signals",
    "Synthesizing insight"
  ];

  let i = 0;
  const timer = setInterval(()=>{
    p += Math.random()*18;
    bar.style.width = Math.min(p,100)+"%";
    if(p > i*25 && i < phases.length) {
      output.innerHTML += `<p>${phases[i++]}</p>`;
    }
    if(p >= 100) {
      clearInterval(timer);
      cb();
    }
  }, 350);
}

/* =========================
   AI ENGINE
========================= */
const AI = {
  domains: {
    tech: /ai|robot|code|system|software/,
    bio: /brain|human|dna|health|biology/,
    space: /space|planet|galaxy|universe/,
    social: /society|economy|culture|people/
  },
  responses: {
    tech: [
      "System architecture displays adaptive intelligence.",
      "Algorithmic efficiency is a dominant signal.",
      "Recursive optimization potential detected."
    ],
    bio: [
      "Organic systems show self-regulating behavior.",
      "Feedback loops dominate biological processes.",
      "Adaptive evolution detected."
    ],
    space: [
      "Cosmic-scale forces govern system behavior.",
      "Temporal distances exceed human intuition.",
      "Observation constraints reduce certainty."
    ],
    social: [
      "Emergent behavior shapes collective outcomes.",
      "Feedback amplification detected.",
      "Stability varies with external pressure."
    ],
    abstract: [
      "Concept operates on symbolic abstraction.",
      "Meaning varies by observer.",
      "Multi-layer interpretation detected."
    ]
  },
  analyze(text) {
    let domain = "abstract";
    for (const d in this.domains) {
      if (this.domains[d].test(text)) domain = d;
    }

    const words = [...new Set(text.split(/\W+/).filter(w=>w.length>4))];
    return {
      domain,
      insight: this.responses[domain][Math.floor(Math.random()*this.responses[domain].length)],
      keywords: words.slice(0,5),
      confidence: (80 + Math.random()*19).toFixed(1)
    };
  }
};

/* =========================
   FINAL ANALYZE
========================= */
function analyze() {
  const text = input.value;
  if (!text) return;

  bootSound();
  thinkingBar(()=>{
    const r = AI.analyze(text);

    output.innerHTML = `
      <h3>AI CORE ONLINE</h3>
      <p><strong>Domain:</strong> ${r.domain.toUpperCase()}</p>
      <p><strong>Keywords:</strong> ${r.keywords.join(", ") || "General patterns"}</p>
      <p><strong>Insight:</strong> ${r.insight}</p>
      <p><strong>Confidence:</strong> ${r.confidence}%</p>
      <p>Status: <span style="color:#7fffba">STABLE</span></p>
    `;

    speak(`Analysis complete. Domain ${r.domain}. Confidence ${r.confidence} percent.`);
  });
}
</script>
